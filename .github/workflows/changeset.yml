name: Changeset

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  changeset:
    name: üì¶ Version Packages
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üèóÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          # Use PAT to allow commits to trigger workflows
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: üì¶ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24.x

      - name: üìÇ Get yarn cache directory
        id: yarn-cache
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: üíæ Cache yarn downloads
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-cache-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-cache-

      - name: üíæ Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: üì• Install dependencies
        run: yarn install --immutable

      - name: üîÑ Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          version: yarn changeset:version
          commit: "chore: version packages"
          title: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: üîç Check if version PR was merged
        id: check-release
        run: |
          # Check if there are no changesets and no open version PR
          # This means the version PR was just merged

          CHANGESET_COUNT=$(ls .changeset/*.md 2>/dev/null | grep -v README.md | wc -l || echo "0")
          echo "Changeset count: $CHANGESET_COUNT"

          if [ "$CHANGESET_COUNT" -eq "0" ] && [ "${{ steps.changesets.outputs.hasChangesets }}" != "true" ]; then
            # Check if current version has a tag
            VERSION=$(node -p "require('./package.json').version")
            TAG="v$VERSION"
            
            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "Tag $TAG already exists"
              echo "should_release=false" >> $GITHUB_OUTPUT
            else
              echo "No tag for $TAG, should release"
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "tag=$TAG" >> $GITHUB_OUTPUT
            fi
          else
            echo "Changesets pending or PR created, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

      - name: üè∑Ô∏è Push tag
        id: push-tag
        if: steps.check-release.outputs.should_release == 'true'
        run: |
          TAG="${{ steps.check-release.outputs.tag }}"

          echo "Creating and pushing tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Get user info from PAT
          USER_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user)
          USER_NAME=$(echo "$USER_DATA" | jq -r '.name // .login')
          USER_ID=$(echo "$USER_DATA" | jq -r '.id')
          USER_LOGIN=$(echo "$USER_DATA" | jq -r '.login')

          git config user.name "$USER_NAME"
          git config user.email "$USER_ID+$USER_LOGIN@users.noreply.github.com"

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: üí¨ Comment on merged PRs
        if: steps.check-release.outputs.should_release == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const tag = '${{ steps.push-tag.outputs.tag }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1. Get list of tags to find the previous one
            const { data: tags } = await github.rest.repos.listTags({
              owner,
              repo,
              per_page: 10
            });

            // Tags are returned latest first
            const currentTagIndex = tags.findIndex(t => t.name === tag);
            const previousTag = tags[currentTagIndex + 1]?.name;

            if (!previousTag) {
              console.log('No previous tag found, likely first release. Skipping PR comments.');
              return;
            }

            console.log(`Comparing releases: ${previousTag} ... ${tag}`);

            // 2. Compare commits between tags
            const comparison = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: previousTag,
              head: tag
            });

            console.log(`Found ${comparison.data.commits.length} commits in release`);

            // 3. Find unique PRs associated with these commits
            const prNumbers = new Set();
            for (const commit of comparison.data.commits) {
              const { data: associatedPrs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: commit.sha
              });
              
              for (const pr of associatedPrs) {
                if (pr.merged_at) {
                  prNumbers.add(pr.number);
                }
              }
            }

            console.log(`Found ${prNumbers.size} PRs to notify: ${Array.from(prNumbers).join(', ')}`);

            // 4. Comment on each unique merged PR
            for (const prNumber of prNumbers) {
              try {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: `üöÄ Released in [${tag}](https://github.com/${owner}/${repo}/releases/tag/${tag})`
                });
                console.log(`‚úÖ Commented on PR #${prNumber}`);
              } catch (error) {
                console.error(`‚ùå Failed to comment on PR #${prNumber}:`, error);
              }
            }
