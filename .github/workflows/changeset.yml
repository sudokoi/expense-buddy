name: Changeset

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  changeset:
    name: Version Packages
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use PAT to allow commits to trigger workflows
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24.x

      - name: Get yarn cache directory
        id: yarn-cache
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          version: yarn changeset:version
          publish: echo "skip-publish"
          commit: "chore: version packages"
          title: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Push tags if version PR was merged
        id: push-tag
        if: steps.changesets.outputs.published == 'true'
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG="v$VERSION"

          echo "Creating and pushing tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Get user info from PAT
          USER_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user)
          USER_NAME=$(echo "$USER_DATA" | jq -r '.name // .login')
          USER_ID=$(echo "$USER_DATA" | jq -r '.id')
          USER_LOGIN=$(echo "$USER_DATA" | jq -r '.login')

          git config user.name "$USER_NAME"
          git config user.email "$USER_ID+$USER_LOGIN@users.noreply.github.com"

          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping"
            echo "skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Comment on merged PR
        if: steps.changesets.outputs.published == 'true' && steps.push-tag.outputs.skipped != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const tag = '${{ steps.push-tag.outputs.tag }}';

            // Find the merged PR for this commit
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });

            const mergedPr = prs.find(pr => pr.merged_at);

            if (mergedPr) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: mergedPr.number,
                body: `ðŸš€ Released as [${tag}](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${tag})`
              });
              console.log(`Commented on PR #${mergedPr.number}`);
            } else {
              console.log('No merged PR found for this commit');
            }
